<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ user.username }}'s Profile</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font for a consistent look */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Fade-in animation for the toast message */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Specific modal animation for a smooth appearance */
        @keyframes animatemodal {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-content {
            animation-name: animatemodal;
            animation-duration: 0.4s;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Toast Notification Message -->
<div id="toast-message"
     class="fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg font-bold z-[1000] transition-opacity duration-300 ease-in-out opacity-0"
     style="animation: fadeIn 0.3s forwards;">
    <!-- Message will be dynamically inserted here -->
</div>

    <!-- Main Profile Container -->
    <div class="profile-wrapper max-w-4xl mx-auto my-5 bg-white rounded-xl shadow-lg overflow-hidden">
        <!-- Top Navigation Bar -->
        <header class="flex justify-between items-center p-4 bg-gray-50 border-b border-gray-200">
            <button onclick="history.back()" class="nav-button bg-green-700 hover:bg-green-800 text-white font-medium py-2 px-4 rounded-xl flex items-center gap-2 transition-colors duration-200">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <a href="{{ url_for('home') }}" class="nav-button bg-green-700 hover:bg-green-800 text-white font-medium py-2 px-4 rounded-xl flex items-center gap-2 transition-colors duration-200">
                <i class="fas fa-home"></i> Home
            </a>
        </header>

        <!-- Cover Photo Section -->
        <div class="cover-photo w-full h-56 overflow-hidden bg-gray-200 relative">
            <a href="#" onclick="showImageModal('{{ cover_photo_url }}')" title="View Full Cover Photo">
                <img src="{{ cover_photo_url }}" alt="Cover Photo" class="w-full h-full object-cover block" onerror="this.onerror=null;this.src='https://placehold.co/1000x220/e0e0e0/777777?text=No+Cover+Photo';"/>
            </a>
        </div>

        <!-- Profile Header Area (Picture, Name, Stats) -->
        <div class="profile-header-area flex items-end -mt-20 px-6 pb-4 relative z-10">
            <div class="profile-picture-container w-36 h-36 rounded-full border-4 border-white bg-gray-200 overflow-hidden flex-shrink-0 shadow-md">
                <a href="#" onclick="showImageModal('{{ profile_pic_url }}')" title="View Full Profile Picture">
                    <img src="{{ profile_pic_url }}" alt="Profile Picture" class="profile-picture w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/140x140/e0e0e0/777777?text=U';"/>
                </a>
            </div>

            <div class="profile-content flex-grow pl-4 text-gray-800">
                <h1 class="text-3xl font-bold text-green-700 mb-1">{{ user.username }}'s Profile</h1>
                <p class="text-sm text-gray-600"><strong>Member Since:</strong> {{ user.created_at }}</p>
                <p class="text-sm text-gray-600"><strong>Last Active:</strong> {{ user.last_active }}</p>
            </div>
        </div>

        <!-- Referral Link Section -->
        <section class="referral-section p-6 border-b border-gray-200 text-center">
            <h3 class="text-xl font-semibold text-green-700 mb-2">Your Referral Link</h3>
            <div class="referral-container flex max-w-xl mx-auto rounded-xl overflow-hidden border border-gray-300">
                <input type="text" id="referralLink" value="{{ referral_link }}" readonly class="flex-grow border-none p-3 text-sm bg-gray-50 focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="copyReferral()" class="copy-btn bg-green-700 hover:bg-green-800 text-white font-medium py-3 px-4 transition-colors duration-200">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </section>

        <!-- Main Content Grid with Profile Sections -->
        <main class="sections-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
            <!-- Basic Info Section -->
            <div class="section-box bg-gray-50 rounded-xl p-4 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-green-700 border-b border-gray-300 pb-2 mb-4">Basic Info</h3>
                <p class="mb-2 text-sm"><strong class="font-bold">Username:</strong> {{ user.username }}</p>
                <p class="mb-2 text-sm"><strong class="font-bold">Business Name:</strong> {{ user.businessname or 'N/A' }}</p>
                <p class="mb-2 text-sm"><strong class="font-bold">First Name:</strong> {{ user.first_name or 'N/A' }}</p>
                <p class="mb-2 text-sm"><strong class="font-bold">Last Name:</strong> {{ user.last_name or 'N/A' }}</p>
                <p class="mb-2 text-sm"><strong class="font-bold">Location:</strong> <span class="location cursor-pointer text-blue-600 hover:text-blue-800 hover:underline transition-colors duration-200" onclick="window.location.href='{{ url_for('personal_details') }}'">{{ user.location or 'N/A' }}</span></p>
                <p class="mb-2 text-sm"><strong class="font-bold">Birthday:</strong> {{ user.birthday if user.birthday else 'N/A' }}</p>
                <p class="mb-2 text-sm"><strong class="font-bold">Sex:</strong> {{ user.sex or 'N/A' }}</p>
                <p class="mt-4 text-sm"><a href="{{ url_for('personal_details') }}" class="text-green-700 hover:underline transition-colors duration-200"><i class="fas fa-edit mr-2"></i> Edit Personal Details</a></p>
            </div>

            <!-- Contact & Security Section -->
            <div class="section-box bg-gray-50 rounded-xl p-4 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-green-700 border-b border-gray-300 pb-2 mb-4">Contact & Security</h3>
                <p class="mb-2 text-sm"><strong class="font-bold">Email:</strong> {{ user.email }} (Verified: {{ 'Yes' if user.is_verified else 'No' }})</p>
                <p class="mb-2 text-sm"><a href="{{ url_for('change_email') }}" class="text-green-700 hover:underline transition-colors duration-200"><i class="fas fa-envelope mr-2"></i> Change Email</a></p>
                <p class="mb-2 text-sm"><strong class="font-bold">Phone:</strong> {{ user.phone_number or 'None' }}</p>
                <p class="mb-2 text-sm"><a href="{{ url_for('change_phone') }}" class="text-green-700 hover:underline transition-colors duration-200"><i class="fas fa-phone-alt mr-2"></i> Change Phone Number</a></p>
                <p class="mb-2 text-sm"><a href="{{ url_for('change_password') }}" class="text-green-700 hover:underline transition-colors duration-200"><i class="fas fa-key mr-2"></i> Change Password</a></p>
                <p class="mt-4 text-sm"><a href="{{ url_for('delete_account') }}" class="text-red-500 hover:underline transition-colors duration-200"><i class="fas fa-trash-alt mr-2"></i> Delete Account</a></p>
            </div>

            <!-- Business & Social Section -->
            <div class="section-box bg-gray-50 rounded-xl p-4 shadow-sm border border-gray-200">
                <h3 class="text-lg font-semibold text-green-700 border-b border-gray-300 pb-2 mb-4">Business & Social</h3>
                {% if user.social_links %}
                    <h4 class="font-semibold mb-2 text-sm">Social Links</h4>
                    <ul class="list-none p-0 mb-4">
                        {% for platform, link in user.social_links.items() %}
                            <li class="mb-1 text-sm"><strong class="font-bold">{{ platform | title }}:</strong> <a href="{{ link }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline transition-colors duration-200">{{ link }} <i class="fas fa-external-link-alt text-xs ml-1"></i></a></li>
                        {% endfor %}
                    </ul>
                {% else %}<p class="text-sm mb-4">No social links set.</p>{% endif %}

                {% if user.working_days %}
                    <h4 class="font-semibold mb-2 text-sm">Working Hours</h4>
                    <ul class="list-none p-0 mb-4">
                        {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                            <li class="mb-1 text-sm">{{ day }}: {{ (user.working_times.get(day, {}).get('open') or 'N/A') }} - {{ (user.working_times.get(day, {}).get('close') or 'N/A') }}</li>
                        {% endfor %}
                    </ul>
                {% else %}<p class="text-sm mb-4">No working hours set.</p>{% endif %}

                <h4 class="font-semibold mb-2 text-sm">Delivery Methods</h4>
                {% if user.delivery_methods %}
                    <ul class="list-none p-0">
                        {% for method in user.delivery_methods %}
                            <li class="mb-1 text-sm"><i class="fas fa-check-square text-green-600 mr-2"></i> {{ method }}</li>
                        {% endfor %}
                    </ul>
                {% else %}<p class="text-sm">No delivery methods set.</p>{% endif %}

                <p class="mt-4 text-sm"><a href="{{ url_for('personal_details') }}" class="text-green-700 hover:underline transition-colors duration-200"><i class="fas fa-briefcase mr-2"></i> Edit Business & Social</a></p>
            </div>
        </main>

        <!-- Profile Options Grid -->
        <section class="sections-container grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-6 bg-gray-100">
            <!-- Regular User Options -->
            <a href="{{ url_for('list_adverts') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-bullhorn text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">My Adverts</span>
            </a>
            <a href="{{ url_for('sell') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200" title="Sell an item or service">
                <i class="fas fa-tag text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Sell</span>
            </a>
            <a href="{{ url_for('user_notifications') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-bell text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Notifications</span>
            </a>
            <a href="{{ url_for('followers') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-users text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Followers</span>
            </a>
            <a href="{{ url_for('settings') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-cog text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Settings</span>
            </a>
            <a href="{{ url_for('faq') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-question-circle text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">FAQs</span>
            </a>
            <a href="{{ url_for('create_post') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-pencil-alt text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Create School Gist</span>
            </a>

            <!-- Admin Buttons - Only show if user is an admin -->
            {% if user and user.is_admin %}
            <a href="{{ url_for('admin_post_airtime') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-mobile-alt text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Post Airtime</span>
            </a>
            <a href="{{ url_for('reported_adverts_admin') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-flag text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Reported Adverts</span>
            </a>
            <a href="{{ url_for('admin_adverts_review') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-check-double text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Review Adverts</span>
            </a>
            <a href="{{ url_for('confirm_bank_transfer') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-money-check-alt text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Confirm Transfers</span>
            </a>
            <a href="{{ url_for('create_post') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-newspaper text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Create School News</span>
            </a>
            <a href="{{ url_for('admin_inbox') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border-2 border-dashed border-green-600">
                <i class="fas fa-inbox text-4xl text-green-700 mb-2"></i>
                <span class="text-sm font-semibold">Admin Inbox</span>
            </a>
            {% endif %}

            <!-- Logout Button -->
            <a href="{{ url_for('logout') }}" class="option-box bg-white p-4 rounded-xl shadow-md flex flex-col items-center justify-center text-center transition-transform hover:scale-105 duration-200 border border-gray-200">
                <i class="fas fa-sign-out-alt text-4xl text-red-500 mb-2"></i>
                <span class="text-sm font-semibold text-red-500">Logout</span>
            </a>
        </section>
    </div>

    <!-- Reusable Image Viewer Modal -->
    <div id="imageViewerModal" class="modal fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-[1000] transition-opacity duration-300 opacity-0">
        <div class="modal-content relative bg-white p-5 rounded-xl shadow-2xl max-w-2xl w-11/12 flex flex-col items-center">
            <span class="close-modal-x absolute top-3 right-5 text-gray-400 hover:text-gray-800 text-3xl font-bold cursor-pointer" onclick="closeImageModal()">&times;</span>
            <img id="fullSizeImage" src="" alt="Full Size Image" class="max-w-full h-auto block mb-4 rounded-lg" />
            <button class="close-modal-btn bg-green-700 hover:bg-green-800 text-white py-2 px-6 rounded-xl transition-colors duration-200" onclick="closeImageModal()">Close</button>
        </div>
    </div>

    <!-- Floating Help Button -->
    <a href="{{ url_for('live_admins_list') }}" class="floating-help fixed bottom-5 right-5 bg-green-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl transition-all duration-200 hover:scale-110 hover:bg-green-800 z-[500]" title="Contact a live admin">
        <i class="fas fa-comments"></i>
    </a>

    <script>
        // Function to show the image viewer modal
        function showImageModal(imageUrl) {
            const modal = document.getElementById('imageViewerModal');
            const fullSizeImage = document.getElementById('fullSizeImage');
            fullSizeImage.src = imageUrl;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            setTimeout(() => modal.style.opacity = '1', 10);
        }

        // Function to close the image viewer modal
        function closeImageModal() {
            const modal = document.getElementById('imageViewerModal');
            modal.style.opacity = '0';
            document.body.style.overflow = '';
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('fullSizeImage').src = '';
            }, 300);
        }

        // Close modal on outside click
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('imageViewerModal');
            if (event.target === modal) {
                closeImageModal();
            }
        });
        
        // Function to show a custom toast message
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast-message');
            toast.textContent = message;
            
            // Set toast color based on type
            let bgColor = '';
            let textColor = '';
            if (type === 'success') {
                bgColor = 'bg-green-600';
                textColor = 'text-white';
            } else if (type === 'error') {
                bgColor = 'bg-red-600';
                textColor = 'text-white';
            } else { // default to info
                bgColor = 'bg-amber-400';
                textColor = 'text-gray-800';
            }

            // Apply Tailwind classes
            toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg font-bold z-[1000] transition-opacity duration-300 ease-in-out opacity-100 ${bgColor} ${textColor}`;
            
            // Hide the toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 3000);
        }

        // Function to copy the referral link and show a custom toast
        function copyReferral() {
            const referralLinkInput = document.getElementById('referralLink');
            referralLinkInput.select();
            referralLinkInput.setSelectionRange(0, 99999);
            try {
                document.execCommand("copy");
                showToast("Referral link copied to clipboard!", 'success');
            } catch (err) {
                showToast("Failed to copy link.", 'error');
            }
        }

        // Display flash messages from the server on page load
        document.addEventListener('DOMContentLoaded', () => {
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
                showToast("{{ message }}", "{{ category }}");
            {% endfor %}
            {% endif %}
            {% endwith %}
        });
    </script>
</body>
</html>
