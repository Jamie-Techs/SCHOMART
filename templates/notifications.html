<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Notifications</title>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            padding-top: 80px;
            background-color: #f0f2f5;
            color: #333;
        }

        /* Fixed Header Styles */
        .header-fixed {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #006B3C; /* Primary color */
            color: white;
            padding: 15px 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-fixed h1 {
            margin: 0;
            font-size: 1.8em;
            color: white;
            text-align: left;
            flex-grow: 1;
        }
        .header-nav {
            display: flex;
            gap: 15px;
        }
        .header-nav .nav-button, .action-button {
            background-color: #FDB813; /* Secondary color */
            color: #006B3C; /* Text color for buttons */
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .header-nav .nav-button:hover, .action-button:hover {
            background-color: #e6a700;
            transform: translateY(-1px);
        }
        .header-nav .nav-button i, .action-button i {
            font-size: 1em;
        }

        /* Main Content Area */
        .content-wrapper {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* Flash Messages */
        .flash-messages {
            list-style: none;
            padding: 10px 0;
            margin: 0 0 20px 0;
        }
        .flash-messages li {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            text-align: center;
        }
        .flash-messages li.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .flash-messages li.danger, .flash-messages li.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .flash-messages li.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Notification List */
        .notification-actions-top {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-bottom: 20px;
        }
        .notification-list {
            list-style: none;
            padding: 0;
        }
        .notification-item {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease-in-out;
            position: relative;
        }
        .notification-item:hover {
            transform: translateY(-3px);
        }
        .notification-item.read {
            opacity: 0.8;
            background-color: #f0f0f0;
            border-color: #d0d0d0;
        }
        .notification-icon {
            font-size: 1.5em;
            margin-right: 15px;
            color: #006B3C;
        }
        .notification-item.read .notification-icon {
            color: #95a5a6;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-content strong {
            display: block;
            font-size: 1.1em;
            color: #2c3e50;
            margin-bottom: 3px;
        }
        .notification-content .message-text {
            color: #555;
            line-height: 1.4;
        }
        .notification-content small {
            display: block;
            color: #7f8c8d;
            font-size: 0.85em;
            margin-top: 5px;
        }
        .notification-actions {
            flex-shrink: 0;
        }
        .notification-actions button {
            background-color: #006B3C;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .notification-actions button:hover {
            background-color: #00562e;
            transform: translateY(-1px);
        }

        /* Clickable Notification Wrapper */
        .clickable-wrapper {
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: center;
            width: 100%;
            cursor: pointer;
        }
        .clickable-wrapper:hover .message-text {
            text-decoration: underline;
        }
        .clickable-wrapper .notification-icon {
            flex-shrink: 0;
        }
        .clickable-wrapper .notification-content {
            flex-grow: 1;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header-fixed {
                flex-direction: column;
                padding: 10px;
            }
            .header-fixed h1 {
                text-align: center;
                margin-bottom: 10px;
            }
            .header-nav {
                width: 100%;
                justify-content: space-around;
                flex-wrap: wrap;
                gap: 8px;
            }
            .header-nav .nav-button {
                flex-grow: 1;
                text-align: center;
            }
            .content-wrapper {
                padding: 0 10px;
            }
            .notification-actions-top {
                flex-direction: column;
                align-items: stretch;
            }
            .notification-actions-top .action-button {
                width: 100%;
            }
            .notification-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .clickable-wrapper {
                flex-direction: column;
                align-items: flex-start;
                padding-bottom: 10px;
            }
            .notification-icon {
                margin-bottom: 10px;
            }
            .notification-actions {
                width: 100%;
                text-align: center;
            }
            .notification-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header-fixed">
        <h1>Your Notifications</h1>
        <div class="header-nav">
            <a href="javascript:history.back()" class="nav-button"><i class="fas fa-arrow-left"></i> Back</a>
            <a href="{{ url_for('home') }}" class="nav-button"><i class="fas fa-home"></i> Home</a>
            {% if current_user_id %}
                <a href="{{ url_for('seller_profile_view', seller_id=current_user_id) }}" class="nav-button"><i class="fas fa-user"></i> Profile</a>
            {% endif %}
        </div>
    </div>

    <div class="content-wrapper">
        <ul class="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </ul>

        <div class="notification-actions-top">
            <button onclick="markAllAsRead()" class="action-button"><i class="fas fa-check-double"></i> Mark All as Read</button>
            <button onclick="deleteAllNotifications()" class="action-button delete-button"><i class="fas fa-trash-alt"></i> Delete All</button>
        </div>

        <ul class="notification-list">
            {% if notifications %}
                {% for notification in notifications %}
                <li class="notification-item {% if notification.is_read %}read{% endif %}" id="notification-{{ notification.id }}">
                    {% set target_url = none %}
                    {# Determine the target URL based on notification type #}
                    {% if notification.notification_type == 'new_advert_from_followed_seller' or notification.notification_type == 'advert_published' %}
                        {% if notification.related_id %}
                            {% set target_url = url_for('advert_detail', advert_id=notification.related_id) %}
                        {% endif %}
                    {% elif notification.notification_type == 'advert_rejected' %}
                        {% set target_url = url_for('list_adverts') %}
                    {% elif notification.notification_type == 'message' %}
                        {% set target_url = url_for('messages') %}
                    {# NEW: Subscription Activated Notification #}
                    {% elif notification.notification_type == 'subscription_activated' %}
                        {# Redirect to the user's profile or subscription management page #}
                        {% set target_url = url_for('sell') %} {# Assuming 'profile' is your user dashboard #}
                    {% endif %}
                    
                    {# Wrap the content in an <a> tag if a target_url is found #}
                    {% if target_url %}
                    <a href="{{ target_url }}" class="clickable-wrapper">
                    {% else %}
                    <div class="clickable-wrapper">
                    {% endif %}

                        <div class="notification-icon">
                            {% if notification.notification_type == 'advert_published' %}
                                <i class="fas fa-bullhorn"></i>
                            {% elif notification.notification_type == 'new_advert_from_followed_seller' %}
                                <i class="fas fa-star"></i>
                            {% elif notification.notification_type == 'message' %}
                                <i class="fas fa-envelope"></i>
                            {% elif notification.notification_type == 'advert_rejected' %}
                                <i class="fas fa-ban"></i>
                            {# NEW: Icon for Subscription Activated #}
                            {% elif notification.notification_type == 'subscription_activated' %}
                                <i class="fas fa-check-circle"></i> <!-- A checkmark circle icon -->
                            {% else %}
                                <i class="fas fa-bell"></i>
                            {% endif %}
                        </div>
                        
                        <div class="notification-content">
                            <strong>{{ notification.notification_type.replace('_', ' ').title() }}</strong>
                            <span class="message-text">{{ notification.notification_message }}</span>
                            <small>{{ notification.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>

                    {% if target_url %}
                    </a>
                    {% else %}
                    </div>
                    {% endif %}

                    {% if not notification.is_read %}
                    <div class="notification-actions">
                        <button onclick="markAsRead({{ notification.id }})">Mark as Read</button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            {% else %}
                <li class="notification-item">No notifications to display.</li>
            {% endif %}
        </ul>
    </div>

    <script>
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    const notificationItem = document.getElementById(`notification-${notificationId}`);
                    if (notificationItem) {
                        notificationItem.classList.add('read');
                        const markReadButton = notificationItem.querySelector('.notification-actions button');
                        if (markReadButton) {
                            markReadButton.remove();
                        }
                    }
                    console.log(data.message);
                } else {
                    console.error('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        async function markAllAsRead() {
            if (!confirm('Are you sure you want to mark all notifications as read?')) {
                return;
            }
            try {
                const response = await fetch('/api/notifications/mark_all_read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    document.querySelectorAll('.notification-item:not(.read)').forEach(item => {
                        item.classList.add('read');
                        const markReadButton = item.querySelector('.notification-actions button');
                        if (markReadButton) {
                            markReadButton.remove();
                        }
                    });
                    console.log(data.message);
                    alert(data.message);
                } else {
                    console.error('Error: ' + data.message);
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                alert('An error occurred while marking all notifications as read.');
            }
        }

        async function deleteAllNotifications() {
            if (!confirm('Are you sure you want to delete all notifications? This action cannot be undone.')) {
                return;
            }
            try {
                const response = await fetch('/api/notifications/delete_all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    const notificationList = document.querySelector('.notification-list');
                    if (notificationList) {
                        notificationList.innerHTML = '<li class="notification-item">No notifications to display.</li>';
                    }
                    console.log(data.message);
                    alert(data.message);
                } else {
                    console.error('Error: ' + data.message);
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting all notifications:', error);
                alert('An error occurred while deleting all notifications.');
            }
        }
    </script>
</body>
</html>
