<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Followers - Futo Jiji</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding: 0;
        }

        /* Top Navigation Bar */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #006B3C; /* Futo Jiji Green */
            padding: 10px 20px;
            color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .top-nav a {
            color: #fff;
            text-decoration: none;
            font-size: 1.2em;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .top-nav a:hover {
            background-color: #004e2c; /* Darker green on hover */
        }

        .top-nav .nav-icon {
            margin-right: 5px;
        }

        /* Search Section */
        .search-section {
            padding: 20px;
            text-align: center;
            background-color: #f9f9f9;
        }
        .search-section input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        /* Tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            background-color: #006B3C;
            color: #fff;
            padding: 10px;
            border-radius: 5px 5px 0 0;
        }
        .tabs button {
            background-color: transparent;
            color: #fff;
            border: none;
            font-size: 18px;
            font-weight: bold;
            padding: 10px 20px;
            cursor: pointer;
        }
        .tabs button.active {
            border-bottom: 2px solid #FDB813;
        }
        /* Content */
        .content {
            padding: 20px;
        }
        /* User List Items */
        .user-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .user-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Profile picture styling */
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        /* Username and picture container */
        .user-info {
            display: flex;
            align-items: center;
        }
        /* Text next to image */
        .user-text {
            display: flex;
            flex-direction: column;
        }
        /* Follow/Unfollow Button */
        .action-button {
            background-color: #006B3C;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            transition: background-color 0.3s;
        }
        .action-button.unfollow {
            background-color: #dc3545; /* Example for unfollow button style */
        }
        .action-button:hover {
            background-color: #004e2c;
        }
        .action-button.unfollow:hover {
            background-color: #c82333; /* Example for unfollow button hover style */
        }
        /* Footer */
        .main-footer {
            background-color: #00391F;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 40px;
        }
    </style>
</head>
<body>

    <nav class="top-nav">
        <a href="javascript:history.back()"><i class="fas fa-arrow-left nav-icon"></i> Back</a>
        <a href="/profile"><i class="fas fa-user-circle nav-icon"></i> Profile</a>
        <a href="/"><i class="fas fa-home nav-icon"></i> Home</a>
    </nav>

    <section class="search-section">
        <input type="text" placeholder="Search for followers, following, or other users..." id="search-bar" />
    </section>
    <div class="search-results" id="search-results" style="display: none;">
        <div class="user-list" id="search-user-list"></div>
    </div>
    <section class="tabs">
        <button class="active" id="followers-tab">Followers</button>
        <button id="following-tab">Following</button>
    </section>

    <section class="content">
        <div class="followers-content" id="followers-content">
            <div class="user-list" id="followers-list">
                {% for follower in followers %}
                <div class="user-list-item" data-user-id="{{ follower.id }}">
                    <div class="user-info">
                        <img src="{{ follower.profile_picture }}" alt="Profile Picture" class="profile-pic"/>
                        <div class="user-text">
                            <p>{{ follower.username }}</p>
                        </div>
                    </div>
                    <button class="action-button follow-btn {{ 'unfollow' if follower.is_followed_by_current_user else '' }}"
                            data-user-id="{{ follower.id }}"
                            data-following="{{ 'true' if follower.is_followed_by_current_user else 'false' }}">
                        {{ 'Unfollow' if follower.is_followed_by_current_user else 'Follow' }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="following-content" id="following-content" style="display: none;">
            <div class="user-list" id="following-list">
                {% for following_user in following %}
                <div class="user-list-item" data-user-id="{{ following_user.id }}">
                    <div class="user-info">
                        <img src="{{ following_user.profile_picture }}" alt="Profile Picture" class="profile-pic"/>
                        <div class="user-text">
                            <p>{{ following_user.username }}</p>
                        </div>
                    </div>
                    <button class="action-button follow-btn unfollow"
                            data-user-id="{{ following_user.id }}"
                            data-following="true">
                        Unfollow
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <footer class="main-footer">
        <p>Â© 2024 Futo Jiji. All rights reserved.</p>
    </footer>

    <script>
        // ----------- Tab Switching -----------
        const followersTab = document.getElementById('followers-tab');
        const followingTab = document.getElementById('following-tab');
        const followersContent = document.getElementById('followers-content');
        const followingContent = document.getElementById('following-content');

        followersTab.addEventListener('click', () => {
            followersTab.classList.add('active');
            followingTab.classList.remove('active');
            followersContent.style.display = 'block';
            followingContent.style.display = 'none';
            clearSearchResults(); // Clear search results when switching tabs
            refreshFollowers(); // Refresh followers list to ensure latest state
        });

        followingTab.addEventListener('click', () => {
            followingTab.classList.add('active');
            followersTab.classList.remove('active');
            followingContent.style.display = 'block';
            followersContent.style.display = 'none';
            clearSearchResults(); // Clear search results when switching tabs
            refreshFollowing(); // Refresh following list to ensure latest state
        });

        // ----------- Search Functionality -----------
        const searchBar = document.getElementById('search-bar');
        const searchResultsContainer = document.getElementById('search-results');
        const searchUserList = document.getElementById('search-user-list');

        let searchTimeout = null;

        function clearSearchResults() {
            searchUserList.innerHTML = '';
            searchResultsContainer.style.display = 'none';
        }

        searchBar.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            const query = searchBar.value.trim();

            if (query === '') {
                clearSearchResults();
                return;
            }

            searchTimeout = setTimeout(() => {
                // Hide current followers/following lists
                followersContent.style.display = 'none';
                followingContent.style.display = 'none';
                // Deactivate tabs
                followersTab.classList.remove('active');
                followingTab.classList.remove('active');

                fetch(`/search-users?query=${encodeURIComponent(query)}`)
                    .then(res => res.json())
                    .then(data => {
                        searchUserList.innerHTML = '';
                        if (data.users && data.users.length > 0) {
                            data.users.forEach(user => {
                                // Create user list item for search results
                                searchUserList.appendChild(createUserListItem(user, true)); // Pass true for search context
                            });
                            searchResultsContainer.style.display = 'block';
                        } else {
                            searchUserList.innerHTML = '<div class="user-list-item"><p>No users found.</p></div>';
                            searchResultsContainer.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching search results:', error);
                        searchUserList.innerHTML = '<div class="user-list-item"><p>Error loading search results.</p></div>';
                        searchResultsContainer.style.display = 'block';
                    });
            }, 300);
        });

        // Hide search results when clicking outside, but not when clicking inside search results or search bar
        document.addEventListener('click', (e) => {
            if (!searchResultsContainer.contains(e.target) && e.target !== searchBar && e.target.closest('.user-list-item') === null) {
                clearSearchResults();
                // When search results are cleared, bring back the active tab's content
                if (followersTab.classList.contains('active')) {
                    followersContent.style.display = 'block';
                } else if (followingTab.classList.contains('active')) {
                    followingContent.style.display = 'block';
                }
            }
        });


        // ----------- Follow/Unfollow Logic -----------
        async function handleFollowUnfollow(userId, button) {
            const isCurrentlyFollowing = button.getAttribute('data-following') === 'true';
            const action = isCurrentlyFollowing ? 'unfollow' : 'follow';

            // Optimistically update the UI
            if (isCurrentlyFollowing) {
                button.textContent = 'Follow';
                button.setAttribute('data-following', 'false');
                button.classList.remove('unfollow');
            } else {
                button.textContent = 'Unfollow';
                button.setAttribute('data-following', 'true');
                button.classList.add('unfollow');
            }

            const url = `/toggle_follow/${userId}?action=${action}`;
            try {
                const res = await fetch(url, { method: 'POST' });
                const data = await res.json();

                if (data.success) {
                    console.log(`User ${userId} ${action}ed successfully.`);
                    // After successful operation, refresh relevant lists
                    refreshFollowers();
                    refreshFollowing();
                    // If currently in search results, also refresh search results to update buttons
                    if (searchResultsContainer.style.display === 'block') {
                           const query = searchBar.value.trim();
                           if (query !== '') {
                                // Re-run the search to update button states
                                // This will trigger the searchBar's input event listener and re-fetch search results
                                searchBar.dispatchEvent(new Event('input'));
                           }
                    }

                } else {
                    // Revert UI if backend operation failed
                    console.error('Backend operation failed:', data.message);
                    if (isCurrentlyFollowing) { // If we optimistically unfollowed, revert to follow
                        button.textContent = 'Unfollow';
                        button.setAttribute('data-following', 'true');
                        button.classList.add('unfollow');
                    } else { // If we optimistically followed, revert to unfollow
                        button.textContent = 'Follow';
                        button.setAttribute('data-following', 'false');
                        button.classList.remove('unfollow');
                    }
                    alert(`Action failed: ${data.message}`); // Inform the user
                }
            } catch (err) {
                console.error('Error in follow/unfollow:', err);
                // Revert UI on network error
                if (isCurrentlyFollowing) {
                    button.textContent = 'Unfollow';
                    button.setAttribute('data-following', 'true');
                    button.classList.add('unfollow');
                } else {
                    button.textContent = 'Follow';
                    button.setAttribute('data-following', 'false');
                    button.classList.remove('unfollow');
                }
                alert('An error occurred during the follow/unfollow action. Please try again.');
            }
        }

        // Event delegation for follow buttons
        document.addEventListener('click', (e) => {
            if (e.target.matches('.follow-btn')) {
                const btn = e.target;
                const userId = btn.getAttribute('data-user-id');
                handleFollowUnfollow(userId, btn);
            }
        });

        // ----------- Refresh lists -----------
        // Renamed 'is_followed' to 'is_followed_status' for clarity to differentiate from the data attribute
        function createUserListItem(user, isSearchContext = false) {
            const div = document.createElement('div');
            div.className = 'user-list-item';
            div.setAttribute('data-user-id', user.id);

            const userInfoDiv = document.createElement('div');
            userInfoDiv.className = 'user-info';

            const img = document.createElement('img');
            img.src = user.profile_picture; // Use profile_picture as per backend
            img.alt = "Profile Picture";
            img.className = 'profile-pic';

            const usernameDiv = document.createElement('div');
            usernameDiv.className = 'user-text';
            const p = document.createElement('p');
            p.textContent = user.username;
            usernameDiv.appendChild(p);

            userInfoDiv.appendChild(img);
            userInfoDiv.appendChild(usernameDiv);

            const btn = document.createElement('button');
            let isFollowedState;

            if (isSearchContext) {
                // For search results, use the 'is_followed' property directly from the search API response
                isFollowedState = user.is_followed;
            } else if (followersTab.classList.contains('active')) {
                // For followers list, use 'is_followed_by_current_user' from the /api/followers response
                isFollowedState = user.is_followed_by_current_user;
            } else {
                // For following list, we are always following these users
                isFollowedState = true; // By definition, in 'following' tab, user is following
            }

            btn.className = `action-button follow-btn ${isFollowedState ? 'unfollow' : ''}`;
            btn.setAttribute('data-user-id', user.id);
            btn.setAttribute('data-following', isFollowedState ? 'true' : 'false');
            btn.textContent = isFollowedState ? 'Unfollow' : 'Follow';

            div.appendChild(userInfoDiv);
            div.appendChild(btn);
            return div;
        }

        async function refreshFollowers() {
            try {
                const res = await fetch('/api/followers');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                const listContainer = document.getElementById('followers-list');
                listContainer.innerHTML = '';
                if (data.followers && data.followers.length > 0) {
                    data.followers.forEach(user => {
                        listContainer.appendChild(createUserListItem(user));
                    });
                } else {
                    listContainer.innerHTML = '<div class="user-list-item"><p>No followers found.</p></div>';
                }
            } catch (err) {
                console.error('Error fetching followers:', err);
                const listContainer = document.getElementById('followers-list');
                listContainer.innerHTML = '<div class="user-list-item"><p>Error loading followers.</p></div>';
            }
        }

        async function refreshFollowing() {
            try {
                const res = await fetch('/api/following');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const data = await res.json();
                const listContainer = document.getElementById('following-list');
                listContainer.innerHTML = '';
                if (data.following && data.following.length > 0) {
                    data.following.forEach(user => {
                        // For 'following' list, 'is_followed' from backend's /api/following is redundant
                        // since all users here are followed. But to be safe, we can use it or hardcode true.
                        // We'll use a hardcoded `true` in createUserListItem for the 'following' tab logic.
                        listContainer.appendChild(createUserListItem(user));
                    });
                } else {
                    listContainer.innerHTML = '<div class="user-list-item"><p>No users being followed.</p></div>';
                }
            } catch (err) {
                console.error('Error fetching following:', err);
                const listContainer = document.getElementById('following-list');
                listContainer.innerHTML = '<div class="user-list-item"><p>Error loading following users.</p></div>';
            }
        }

        // ----------- Initialize on DOM load -----------
        document.addEventListener('DOMContentLoaded', () => {
            // No need to call refreshFollowers() and refreshFollowing() here
            // because the initial data is rendered by Jinja in the HTML template.
            // These functions will be called upon tab switching or follow/unfollow actions.
        });
    </script>
</body>
</html>