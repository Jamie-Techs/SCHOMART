<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schomart | Sign Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Custom styles for the app */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdf4;
        }
        .bg-primary { background-color: #006B3C; }
        .text-primary { color: #006B3C; }
        .btn-primary {
            background-color: #006B3C;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover { background-color: #025730; }
        .input-group input { padding-left: 2.5rem; }

        /* Styles to ensure input visibility and use Font Awesome */
        input[type="text"],
        input[type="email"],
        input[type="password"] {
            border-color: #006B3C;
            border-width: 2px;
            background-color: #f9fffb;
            color: #000;
            font-weight: 500;
        }
        
        input[type="text"]::placeholder,
        input[type="email"]::placeholder,
        input[type="password"]::placeholder {
            color: #888;
        }
        
        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="password"]:focus {
            box-shadow: 0 0 0 3px rgba(0, 107, 60, 0.4);
        }

        .fa-solid {
            color: #006B3C;
        }

        #signup-form .relative {
            position: relative;
        }
        
        #signup-form .relative .absolute {
            left: 0.75rem; /* Adjust padding for icon */
            top: 50%;
            transform: translateY(-50%);
        }

        #signup-form .relative input {
            padding-left: 3rem; /* Increase padding for icon */
        }

        /* Added styles for the policy checkbox */
        .policy-container {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: -10px; /* Adjust spacing */
        }

        .policy-container input[type="checkbox"] {
            margin-top: 4px; /* Align with text */
            accent-color: #006B3C;
        }

        .policy-container a {
            color: #006B3C;
            font-weight: 600;
            text-decoration: underline;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg p-8 space-y-8 bg-white rounded-xl shadow-2xl ring-2 ring-primary">
        <div class="text-center">
            <h2 class="text-3xl font-extrabold text-primary">Schomart</h2>
            <p class="mt-2 text-sm text-gray-600">Create your account</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="space-y-2">
            {% for category, message in messages %}
            <div class="px-4 py-2 rounded-md font-medium
                {% if category == 'success' %} bg-green-100 text-green-800
                {% elif category == 'error' %} bg-red-100 text-red-800
                {% elif category == 'info' %} bg-blue-100 text-blue-800
                {% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form id="signup-form" class="space-y-6">
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fa-solid fa-user text-gray-400"></i>
                    </div>
                    <input id="username" name="username" type="text" autocomplete="username" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-primary focus:ring-primary sm:text-sm">
                </div>
            </div>

            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email address</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fa-solid fa-envelope text-gray-400"></i>
                    </div>
                    <input id="email" name="email" type="email" autocomplete="email" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-primary focus:ring-primary sm:text-sm">
                </div>
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fa-solid fa-lock text-gray-400"></i>
                    </div>
                    <input id="password" name="password" type="password" autocomplete="new-password" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-primary focus:ring-primary sm:text-sm">
                </div>
            </div>

            <div>
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                        <i class="fa-solid fa-lock text-gray-400"></i>
                    </div>
                    <input id="confirm-password" name="confirm-password" type="password" autocomplete="new-password" required class="block w-full rounded-md border-gray-300 pl-10 focus:border-primary focus:ring-primary sm:text-sm">
                </div>
            </div>

            <div class="flex items-start policy-container">
                <input id="agree-policy" name="agree-policy" type="checkbox" required class="h-4 w-4 text-primary rounded border-gray-300 focus:ring-primary">
                <label for="agree-policy" class="text-sm text-gray-700">
                    I agree to the <a href="/policy" target="_blank" class="text-primary hover:underline">SCHOMART Policy</a>
                </label>
            </div>

            <div class="space-y-2">
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    <i class="fa-solid fa-user-plus mr-2"></i>
                    Sign Up
                </button>
                <a href="/login" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300 text-center">
                    Already have an account? Log In
                </a>
            </div>
        </form>
        <div id="message" class="text-center mt-4"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBEJOF1jZAIIV8_i6xvUHlSKeqOlcQ-Sgo",
            authDomain: "schomart-7a743.firebaseapp.com",
            projectId: "schomart-7a743",
            storageBucket: "schomart-7a743.appspot.com",
            messagingSenderId: "20119186662",
            appId: "1:20119186662:web:da1755b55dacde4fa6df27",
            measurementId: "G-9QGL3XHSC7"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const form = document.getElementById('signup-form');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const agreePolicyCheckbox = document.getElementById('agree-policy');
        const messageDiv = document.getElementById('message');

        function showMessage(text, isError = false) {
            messageDiv.textContent = text;
            messageDiv.className = isError ? 'text-red-500 font-medium' : 'text-green-600 font-medium';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value;
            const email = emailInput.value;
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;
            
            showMessage('Processing...', false);

            if (password !== confirmPassword) {
                showMessage('Passwords do not match.', true);
                return;
            }

            if (password.length < 8) {
                showMessage('Password must be at least 8 characters long.', true);
                return;
            }

            // ADDED: Check if policy checkbox is ticked
            if (!agreePolicyCheckbox.checked) {
                showMessage('You must agree to the SCHOMART Policy to sign up.', true);
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                const referralCode = Math.random().toString(36).substring(2, 10).toUpperCase();

                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    username: username,
                    email: email,
                    created_at: firebase.firestore.FieldValue.serverTimestamp(),
                    last_active: firebase.firestore.FieldValue.serverTimestamp(),
                    last_online: firebase.firestore.FieldValue.serverTimestamp(),
                    token_created_at: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    first_name: "",
                    last_name: "",
                    phone_number: "",
                    sex: "",
                    businessname: "",
                    location: "",
                    state: "",
                    school: "",
                    full_location: "",
                    cover_photo: "",
                    profile_picture: "",
                    has_posted_free_ad: false,
                    is_admin: false,
                    is_online: true,
                    referral_code: referralCode,
                    referral_count: 0,
                    referral_link: `https://schomart.onrender.com/signup?ref=${referralCode}`,
                    delivery_methods: ["Pickup"],
                    social_links: {
                        facebook: "",
                        instagram: "",
                        linkedin: "",
                        twitter: "",
                        website: ""
                    },
                    last_email_otp_sent_at: null,
                    email_code_expiry: null,
                    last_referral_verification_at: null,
                });

                await user.sendEmailVerification();
                showMessage('Signup successful! Please check your email for a verification link before logging in. If you do not see the email, please check your spam or junk folder. To ensure you receive future emails from us, please mark it as "Not Spam".', false);
            } catch (error) {
                console.error("Authentication Error:", error);
                switch(error.code) {
                    case 'auth/email-already-in-use':
                        showMessage('This email is already registered. Please log in.', true);
                        break;
                    case 'auth/invalid-email':
                        showMessage('The email address is not valid.', true);
                        break;
                    case 'auth/weak-password':
                        showMessage('Password should be at least 6 characters long.', true);
                        break;
                    case 'auth/operation-not-allowed':
                        showMessage('Email/Password sign-in is not enabled. Please contact support.', true);
                        break;
                    default:
                        showMessage('An unexpected error occurred. Please try again.', true);
                }
            }
        });
    </script>
</body>
</html>
