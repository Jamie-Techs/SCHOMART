<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Signup/Login Page</title>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-auth-compat.js"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background-color: #f0f0f0;
  }
  .container {
    max-width: 400px;
    margin: 50px auto;
    background-color: #fff;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
  }

  h2 {
    text-align: center;
    margin-bottom: 1.5rem;
    color: #006B3C;
  }

  form {
    display: flex;
    flex-direction: column;
  }

  input {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  button {
    background-color: #006B3C;
    color: #fff;
    border: none;
    padding: 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    margin-bottom: 1rem;
  }

  button:hover {
    background-color: #004d2b;
  }

  .link {
    text-align: center;
    margin-top: 0.5rem;
  }
  .link a {
    color: #FDB813;
    cursor: pointer;
    text-decoration: none;
  }
  .error {
    color: red;
    font-size: 0.9em;
    margin-bottom: 1rem;
    text-align: center;
  }
</style>
</head>
<body>

<div class="container" id="auth-container">
  <h2 id="form-title">Login</h2>

  <div class="error" id="error-message"></div>

  <form id="auth-form">
    <input type="email" id="email" placeholder="Email" required />
    <input type="password" id="password" placeholder="Password" required />
    <button type="submit" id="submit-btn">Login</button>
  </form>
  <div class="link" id="toggle-link">
    <a id="switch-to-signup">Don't have an account? Sign Up</a>
  </div>
  <div class="link" style="margin-top: 0.5rem;">
    <a id="forgot-password" style="font-size: 0.9em;">Forgot Password?</a>
  </div>
</div>

<!-- Firebase Config: Replace with your actual config -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBEJOF1jZAIIV8_i6xvUHlSKeqOlcQ-Sgo",
    authDomain: "schomart-7a743.firebaseapp.com",
    projectId: "schomart-7a743",
    storageBucket: "schomart-7a743.appspot.com",
    messagingSenderId: "20119186662",
    appId: "1:20119186662:web:da1755b55dacde4fa6df27",
    measurementId: "G-9QGL3XHSC7"
  };
  firebase.initializeApp(firebaseConfig);
</script>

<script>
  const authContainer = document.getElementById('auth-container');
  const formTitle = document.getElementById('form-title');
  const authForm = document.getElementById('auth-form');
  const errorMessage = document.getElementById('error-message');
  const toggleLink = document.getElementById('switch-to-signup');
  const forgotPasswordLink = document.getElementById('forgot-password');

  let isSignup = false; // toggle between login and signup

  // Switch form mode
  document.getElementById('switch-to-signup').addEventListener('click', () => {
    isSignup = !isSignup;
    updateForm();
  });

  function updateForm() {
    errorMessage.innerText = '';
    if (isSignup) {
      formTitle.innerText = 'Sign Up';
      authForm.querySelector('button').innerText = 'Sign Up';
      document.getElementById('forgot-password').style.display = 'none';
    } else {
      formTitle.innerText = 'Login';
      authForm.querySelector('button').innerText = 'Login';
      document.getElementById('forgot-password').style.display = 'block';
    }
  }

  // Handle form submit
  authForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorMessage.innerText = '';

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();

    try {
      if (isSignup) {
        // Sign up with Firebase
        const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        await user.sendEmailVerification();

        // Send UID to backend to create user in Firestore
        const idToken = await user.getIdToken();

        await fetch('/api/signup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify({
            email: email,
            username: email.split('@')[0], // or ask for username separately
            uid: user.uid
          })
        });
        alert('Signup successful! Please verify your email before logging in.');
        updateForm();
      } else {
        // Login
        const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        if (!user.emailVerified) {
          alert('Please verify your email before logging in.');
          await firebase.auth().signOut();
          return;
        }

        const idToken = await user.getIdToken();

        // Verify token on backend
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify({ idToken })
        });

        if (response.ok) {
          // Redirect to profile page
          window.location.href = '/';
        } else {
          const data = await response.json();
          errorMessage.innerText = data.error || 'Login failed.';
        }
      }
    } catch (err) {
      console.error(err);
      errorMessage.innerText = err.message || 'An error occurred.';
    }
  });

  // Forgot Password
  forgotPasswordLink.addEventListener('click', () => {
    const email = document.getElementById('email').value.trim();
    if (!email) {
      alert('Please enter your email to reset password.');
      return;
    }
    firebase.auth().sendPasswordResetEmail(email)
      .then(() => {
        alert('Password reset email sent. Please check your email.');
      })
      .catch((error) => {
        alert(error.message);
      });
  });

  // Initialize form
  updateForm();
</script>

</body>
</html>
