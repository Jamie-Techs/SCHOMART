<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Advert</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #006B3C;
            text-align: center;
        }
        .form-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
        }
        .form-section h3 {
            margin-top: 0;
            color: #FDB813;
        }
        label {
            display: block;
            margin-top: 10px;
            color: #333;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .file-upload {
            border: 1px dashed #ccc;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
        }
        .button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            background-color: #006B3C;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .button:hover {
            background-color: #00522a;
        }
        .advert-options {
            list-style: none;
            padding: 0;
        }
        .advert-options li {
            padding: 10px;
            margin-bottom: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .advert-options li.selected {
            border-color: #FDB813;
            background-color: #fff8e1;
        }
        .advert-options h4 {
            margin: 0 0 5px 0;
            color: #006B3C;
        }
        .advert-options p {
            margin: 0;
            font-size: 0.9em;
            color: #555;
        }
        #cost_summary {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
        }
        #cost_summary p {
            margin: 5px 0;
            font-size: 1.1em;
        }
        .error-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Post a New Advert</h1>
        <form id="advertForm" action="{{ url_for('sell', advert_id=advert_id) }}" method="post" enctype="multipart/form-data">

            <div class="form-section">
                <h3>Advert Details</h3>
                <label for="title">Advert Title</label>
                <input type="text" id="title" name="title" value="{{ form_data.get('title', '') }}" required>
                
                <label for="category">Category</label>
                <select id="category" name="category" required>
                    <option value="">Select Category</option>
                    {% for category in categories %}
                        <option value="{{ category.name }}" {% if form_data.get('category') == category.name %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>

                <label for="description">Description</label>
                <textarea id="description" name="description" rows="5" required>{{ form_data.get('description', '') }}</textarea>

                <label for="price">Price (₦)</label>
                <input type="number" id="price_input" name="price" value="{{ form_data.get('price', '') }}" step="0.01" required>

                <label for="negotiable">Price Negotiable?</label>
                <select id="negotiable" name="negotiable" required>
                    <option value="No" {% if form_data.get('negotiable') == 'No' %}selected{% endif %}>No</option>
                    <option value="Yes" {% if form_data.get('negotiable') == 'Yes' %}selected{% endif %}>Yes</option>
                </select>
            </div>

            <div class="form-section">
                <h3>Location & Delivery</h3>
                <label for="state">State</label>
                <select id="state" name="state" required>
                    <option value="">Select State</option>
                    {% for state in NIGERIAN_STATES %}
                        <option value="{{ state }}" {% if form_data.get('state') == state %}selected{% endif %}>{{ state }}</option>
                    {% endfor %}
                </select>
                <label for="school">School (Optional)</label>
                <select id="school" name="school">
                    <option value="">Select School</option>
                </select>
                <label for="specific_location">Specific Location (e.g., Hostel name)</label>
                <input type="text" id="specific_location" name="specific_location" value="{{ form_data.get('specific_location', '') }}">
            </div>

            <div class="form-section">
                <h3>Images & Videos</h3>
                <label for="main_image">Main Image (Required)</label>
                <input type="file" id="main_image" name="main_image" accept="image/*">
                {% if advert_data and advert_data.get('main_image') %}
                    <p>Current Main Image: <a href="{{ advert_data.get('main_image') }}" target="_blank">View Image</a></p>
                    <input type="hidden" name="existing_main_image" value="{{ advert_data.get('main_image') }}">
                {% endif %}
                </div>

            <div class="form-section">
                <h3>Select Advert Plan</h3>
                <ul class="advert-options" id="advert-options-list">
                    {% for option in available_options %}
                        <li data-plan-name="{{ option.plan_name }}" 
                            data-is-free="{{ option.is_free }}" 
                            data-min-duration="{{ option.min_duration_days|default(0) }}"
                            data-max-duration="{{ option.max_duration_days|default(0) }}"
                            data-fixed-duration="{{ option.advert_duration_days|default(0) }}"
                            data-visibility-level="{{ option.visibility_level }}"
                            class="{% if form_data.get('plan_name') == option.plan_name %}selected{% endif %}">
                            <input type="radio" name="posting_option" value="{{ option.plan_name }}" style="display:none;" {% if form_data.get('posting_option') == option.plan_name %}checked{% endif %}>
                            <h4>{{ option.label }}</h4>
                            <p>{{ option.cost_description }}</p>
                            <p>Visibility: <b>{{ option.visibility_level }}</b></p>
                        </li>
                    {% endfor %}
                </ul>

                <div id="duration-section" style="display:none;">
                    <label for="advert_duration_days">Advert Duration (Days)</label>
                    <input type="number" id="advert_duration_days" name="advert_duration_days" value="{{ form_data.get('advert_duration_days', '') }}" min="1">
                    <p id="duration-info"></p>
                </div>
            </div>

            <div id="cost_summary">
                <p>Selected Plan: <b id="selectedPlanName"></b></p>
                <p>Visibility Multiplier: <b id="visibilityMultiplierDisplay">1.0</b></p>
                <p>Calculated Cost: <b id="calculatedCostDisplay">₦0.00</b></p>
            </div>

            <button type="submit" class="button">Post Advert</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const advertOptionsList = document.getElementById('advert-options-list');
            const durationSection = document.getElementById('duration-section');
            const durationInput = document.getElementById('advert_duration_days');
            const durationInfo = document.getElementById('duration-info');
            const priceInput = document.getElementById('price_input');
            const visibilityMultiplierDisplay = document.getElementById('visibilityMultiplierDisplay');
            const calculatedCostDisplay = document.getElementById('calculatedCostDisplay');
            const selectedPlanNameDisplay = document.getElementById('selectedPlanName');

            // Python data passed to JS
            const VISIBILITY_MULTIPLIERS = {{ VISIBILITY_MULTIPLIERS|tojson }};

            function updateCost() {
                // Find the currently selected radio button and its parent list item
                const selectedRadioButton = advertOptionsList.querySelector('input[name="posting_option"]:checked');
                let selectedOption;

                if (selectedRadioButton) {
                    selectedOption = selectedRadioButton.closest('li');
                }
                
                if (!selectedOption) {
                    // Handle the case where no option is selected
                    visibilityMultiplierDisplay.textContent = '1.0';
                    calculatedCostDisplay.textContent = '₦0.00';
                    selectedPlanNameDisplay.textContent = 'None';
                    durationSection.style.display = 'none';
                    return;
                }
                
                // Read data attributes from the selected li element
                const isFree = selectedOption.dataset.isFree === 'True';
                const planName = selectedOption.dataset.planName;
                const visibilityLevel = selectedOption.dataset.visibilityLevel;
                const multiplier = VISIBILITY_MULTIPLIERS[visibilityLevel] || 1.0;
                
                selectedPlanNameDisplay.textContent = selectedOption.querySelector('h4').textContent;
                visibilityMultiplierDisplay.textContent = multiplier.toFixed(1);

                if (isFree || planName.startsWith('referral')) {
                    // Fixed duration and free cost for these plans
                    durationInput.value = selectedOption.dataset.fixedDuration;
                    durationSection.style.display = 'block';
                    durationInfo.textContent = `This plan has a fixed duration of ${selectedOption.dataset.fixedDuration} days.`;
                    calculatedCostDisplay.textContent = '₦0.00';
                    priceInput.disabled = true;
                } else {
                    // Paid plans with customizable duration
                    durationSection.style.display = 'block';
                    durationInfo.textContent = `Duration must be between ${selectedOption.dataset.minDuration} and ${selectedOption.dataset.maxDuration} days.`;
                    priceInput.disabled = false;
                    
                    const productPrice = parseFloat(priceInput.value) || 0;
                    const durationDays = parseInt(durationInput.value) || 0;
                    
                    if (productPrice > 0 && durationDays > 0) {
                        let calculatedCost = 0.01 * productPrice * durationDays * multiplier;
                        calculatedCost = Math.max(calculatedCost, 100);
                        calculatedCostDisplay.textContent = `₦${calculatedCost.toFixed(2)}`;
                    } else {
                        calculatedCostDisplay.textContent = '₦0.00';
                    }
                }
            }

            // Event listeners for selecting an option
            advertOptionsList.querySelectorAll('li').forEach(item => {
                item.addEventListener('click', function() {
                    advertOptionsList.querySelectorAll('li').forEach(li => li.classList.remove('selected'));
                    this.classList.add('selected');
                    this.querySelector('input[type="radio"]').checked = true;
                    updateCost();
                });
            });

            // Event listeners for dynamic calculation
            priceInput.addEventListener('input', updateCost);
            durationInput.addEventListener('input', updateCost);

            // Initial update on page load
            updateCost();
            
            // Handle school dropdown based on state selection
            const stateSelect = document.getElementById('state');
            const schoolSelect = document.getElementById('school');
            const nigerianSchools = {{ NIGERIAN_SCHOOLS|tojson }};

            function updateSchools() {
                const selectedState = stateSelect.value;
                const schools = nigerianSchools[selectedState] || [];
                schoolSelect.innerHTML = '<option value="">Select School</option>';
                schools.forEach(school => {
                    const option = document.createElement('option');
                    option.value = school.name;
                    option.textContent = school.name;
                    if (school.name === '{{ form_data.get('school', '') }}') {
                        option.selected = true;
                    }
                    schoolSelect.appendChild(option);
                });
            }
            stateSelect.addEventListener('change', updateSchools);
            updateSchools();
        });
    </script>
</body>
</html>
