<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schomart: Sign Up & Log In</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for modern, clean look */
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            padding: 0.75rem;
            transition: all 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
        .form-button {
            transition: background-color 0.2s ease-in-out;
        }
        .form-button:hover {
            background-color: #4338ca;
        }
        .form-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100 p-4">

    <!-- Auth Container -->
    <div class="card w-full max-w-md p-8 md:p-10 text-center">
        <!-- Message Area -->
        <div id="message-box" class="mb-6 p-4 text-center rounded-lg hidden"></div>

        <!-- Form Toggler -->
        <div class="mb-8">
            <button id="show-signup" class="px-6 py-2 rounded-full font-semibold focus:outline-none transition-colors duration-200 bg-indigo-600 text-white">Sign Up</button>
            <button id="show-login" class="px-6 py-2 rounded-full font-semibold focus:outline-none transition-colors duration-200 bg-gray-200 text-gray-800 ml-4">Log In</button>
        </div>

        <!-- Sign Up Form -->
        <form id="signup-form" class="space-y-6">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Create Your Account</h2>
            <div>
                <input type="text" id="signup-username" placeholder="Username" required class="form-input w-full">
            </div>
            <div>
                <input type="email" id="signup-email" placeholder="Email Address" required class="form-input w-full">
            </div>
            <div>
                <input type="password" id="signup-password" placeholder="Password" required class="form-input w-full">
            </div>
            <div>
                <input type="text" id="referral-code" placeholder="Referral Code (Optional)" class="form-input w-full">
            </div>
            <button type="submit" class="form-button w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-indigo-700">Sign Up</button>
        </form>

        <!-- Log In Form (initially hidden) -->
        <form id="login-form" class="space-y-6 hidden">
            <h2 class="text-3xl font-bold text-gray-900 mb-6">Log In to Your Account</h2>
            <div>
                <input type="email" id="login-email" placeholder="Email Address" required class="form-input w-full">
            </div>
            <div>
                <input type="password" id="login-password" placeholder="Password" required class="form-input w-full">
            </div>
            <button type="submit" class="form-button w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-indigo-700">Log In</button>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>

    <script>
        // Use a self-invoking anonymous function to keep variables out of the global scope
        (function() {
            // Firebase configuration provided by the user
            const firebaseConfig = {
                apiKey: "AIzaSyBEJOF1jZAIIV8_i6xvUHlSKeqOlcQ-Sgo",
                authDomain: "schomart-7a743.firebaseapp.com",
                projectId: "schomart-7a743",
                storageBucket: "schomart-7a743.appspot.com",
                messagingSenderId: "20119186662",
                appId: "1:20119186662:web:da1755b55dacde4fa6df27",
                measurementId: "G-9QGL3XHSC7"
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);

            const auth = firebase.auth();

            // DOM elements
            const signupForm = document.getElementById('signup-form');
            const loginForm = document.getElementById('login-form');
            const showSignupBtn = document.getElementById('show-signup');
            const showLoginBtn = document.getElementById('show-login');
            const messageBox = document.getElementById('message-box');

            // --- UI Helper Functions ---
            
            // Function to show a message to the user
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                
                if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else { // info or loading
                    messageBox.classList.add('bg-blue-100', 'text-blue-700');
                }
                
                messageBox.classList.remove('hidden');
                messageBox.scrollIntoView({ behavior: 'smooth' });
            }

            // Function to toggle between forms
            function toggleForms(showForm) {
                if (showForm === 'signup') {
                    signupForm.classList.remove('hidden');
                    loginForm.classList.add('hidden');
                    showSignupBtn.classList.remove('bg-gray-200', 'text-gray-800');
                    showSignupBtn.classList.add('bg-indigo-600', 'text-white');
                    showLoginBtn.classList.remove('bg-indigo-600', 'text-white');
                    showLoginBtn.classList.add('bg-gray-200', 'text-gray-800');
                } else {
                    loginForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                    showLoginBtn.classList.remove('bg-gray-200', 'text-gray-800');
                    showLoginBtn.classList.add('bg-indigo-600', 'text-white');
                    showSignupBtn.classList.remove('bg-indigo-600', 'text-white');
                    showSignupBtn.classList.add('bg-gray-200', 'text-gray-800');
                }
                messageBox.classList.add('hidden');
            }

            // Event listeners for form toggling
            showSignupBtn.addEventListener('click', () => toggleForms('signup'));
            showLoginBtn.addEventListener('click', () => toggleForms('login'));

            // --- Form Submission Handlers ---

            // Handle the signup form submission
            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const username = document.getElementById('signup-username').value;
                const referralCode = document.getElementById('referral-code').value;

                // Disable button and show loading message
                const signupBtn = signupForm.querySelector('button[type="submit"]');
                signupBtn.disabled = true;
                showMessage('Creating account...', 'info');

                try {
                    // 1. Create user with Firebase Auth
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // 2. Get the ID token for the backend call (if needed, but for signup it's a direct API call)
                    const idToken = await user.getIdToken();

                    // 3. Call your backend `/api/signup` endpoint to create the Firestore document
                    const response = await fetch('/api/signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // The backend checks for the Authorization header.
                            // Even though the backend signup route doesn't strictly need it,
                            // it's a good practice to include it for consistency.
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            username: username,
                            referralCode: referralCode || null,
                        })
                    });

                    // 4. Handle the backend response
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('Account created successfully! You can now log in.', 'success');
                        // Optional: automatically switch to the login form
                        setTimeout(() => toggleForms('login'), 2000);
                    } else {
                        // Backend error (e.g., user already exists)
                        showMessage(`Error: ${data.error}`, 'error');
                        // Log out the user from Firebase Auth if the backend signup failed, to allow for a retry
                        await auth.signOut();
                    }
                } catch (error) {
                    // Firebase Auth error (e.g., weak password, invalid email) or network error
                    showMessage(`Sign up failed: ${error.message}`, 'error');
                } finally {
                    signupBtn.disabled = false;
                }
            });

            // Handle the login form submission
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                // Disable button and show loading message
                const loginBtn = loginForm.querySelector('button[type="submit"]');
                loginBtn.disabled = true;
                showMessage('Logging in...', 'info');

                try {
                    // 1. Authenticate user with Firebase Auth
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;

                    // 2. Get the user's ID token
                    const idToken = await user.getIdToken();
                    
                    // Store the token for future use on protected pages
                    localStorage.setItem('firebaseIdToken', idToken);
                    
                    // 3. Call your backend `/api/login` endpoint to verify the token
                    // The backend will now simply verify the token.
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // The backend expects the token in the body for this specific endpoint
                        },
                        body: JSON.stringify({ idToken: idToken })
                    });
                    
                    // 4. Handle the backend response
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('Login successful! You can now access protected pages.', 'success');
                        // Redirect to the home page or a protected route
                        // Example: window.location.href = '/protected_page';
                    } else {
                        // Backend failed to verify token
                        showMessage(`Login failed: ${data.error}`, 'error');
                        // Log out the user from Firebase Auth
                        await auth.signOut();
                    }
                } catch (error) {
                    // Firebase Auth error (e.g., wrong password, user not found) or network error
                    showMessage(`Login failed: ${error.message}`, 'error');
                } finally {
                    loginBtn.disabled = false;
                }
            });

        })();
    </script>
</body>
</html>
