<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGPA Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* ... (Your existing styles) ... */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: 30px auto;
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 25px;
        }
        .course-input {
            display: grid;
            grid-template-columns: 1fr 120px 100px 50px;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .course-input label {
            font-weight: bold;
            color: #555;
        }
        .course-input input[type="text"],
        .course-input select,
        .course-input input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .add-course-btn, .calculate-btn {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .add-course-btn:hover, .calculate-btn:hover {
            background-color: #0056b3;
        }
        .remove-course-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }
        .remove-course-btn:hover {
            background-color: #c82333;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #007bff;
            border-radius: 8px;
            background-color: #e9f5ff;
            text-align: center;
        }
        .results h2 {
            color: #007bff;
            margin-bottom: 15px;
        }
        .results p, .results h3 {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .grading-info {
            margin-top: 30px;
            font-size: 0.9em;
            text-align: left;
            border-top: 1px solid #ccc;
            padding-top: 20px;
            color: #555;
        }
        .grading-info h3 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 10px;
        }
        .class-of-degree {
            font-size: 1.2em;
            font-weight: bold;
            color: #0056b3;
            margin-top: 15px;
        }
        .tcgpa-input {
            margin-bottom: 20px;
        }
        .tcgpa-input label {
            font-weight: bold;
        }
        .tcgpa-input input {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 150px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>University CGPA Calculator</h1>

        <div class="tcgpa-input">
            <label for="tcgpa">Total CGPA from Previous Semesters:</label>
            <input type="number" id="tcgpa" step="0.01" min="0" max="5.0" placeholder="e.g., 3.5">
        </div>

        <div id="courseInputs">
            </div>

        <button type="button" class="add-course-btn">Add Course</button>
        <button type="button" class="calculate-btn">Calculate CGPA</button>

        <div id="results" class="results" style="display: none;">
            <h2>Your Calculated Results:</h2>
            <p><strong>Total Grade Points:</strong> <span id="totalGradePoints">0.00</span></p>
            <p><strong>CGPA for this Semester:</strong> <span id="cgpaValue">0.00</span></p>
            <h3 id="classOfDegree"></h3>
        </div>

        <div id="message" class="message" style="display: none;"></div>

        <div class="grading-info">
            <h3>Grading and Classifications</h3>
            <p><strong>The following grading scale is based on a common Nigerian university system:</strong></p>
            <ul>
                <li><strong>70 - 100:</strong> Grade A (5.00 Grade Point)</li>
                <li><strong>60 - 69:</strong> Grade B (4.00 Grade Point)</li>
                <li><strong>50 - 59:</strong> Grade C (3.00 Grade Point)</li>
                <li><strong>45 - 49:</strong> Grade D (2.00 Grade Point)</li>
                <li><strong>40 - 44:</strong> Grade E (1.00 Grade Point)</li>
                <li><strong>0 - 39:</strong> Grade F (0.00 Grade Point)</li>
            </ul>
            <p><strong>Classes of Degree:</strong></p>
            <ul>
                <li><strong>4.50 - 5.00:</strong> First Class Honours</li>
                <li><strong>3.50 - 4.49:</strong> Second Class Honours (Upper Division)</li>
                <li><strong>2.40 - 3.49:</strong> Second Class Honours (Lower Division)</li>
                <li><strong>1.50 - 2.39:</strong> Third Class Honours</li>
                <li><strong>Below 1.50:</strong> Pass/Fail</li>
            </ul>
        </div>
    </div>

    <script>
        const courseInputsDiv = document.getElementById('courseInputs');
        const resultsDiv = document.getElementById('results');
        const cgpaValueSpan = document.getElementById('cgpaValue');
        const totalGradePointsSpan = document.getElementById('totalGradePoints');
        const messageDiv = document.getElementById('message');
        const classOfDegreeH3 = document.getElementById('classOfDegree');
        const tcgpaInput = document.getElementById('tcgpa');
        let courseCounter = 0; // Use a counter to create unique IDs

        // Function to display messages
        function showMessage(msg, type = 'error') {
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
        }

        // Function to hide messages
        function hideMessage() {
            messageDiv.style.display = 'none';
        }
        
        // Function to add a new course input row
        function addCourseInput(courseData = {}) {
            courseCounter++;
            const courseDiv = document.createElement('div');
            courseDiv.className = 'course-input';
            courseDiv.setAttribute('data-id', courseCounter);

            courseDiv.innerHTML = `
                <div>
                    <label for="courseName${courseCounter}">Course Name:</label>
                    <input type="text" id="courseName${courseCounter}" placeholder="e.g., CSC 101" value="${courseData.course_name || ''}" required>
                </div>
                <div>
                    <label for="grade${courseCounter}">Grade:</label>
                    <select id="grade${courseCounter}" required>
                        <option value="">--Select Grade--</option>
                        <option value="A" ${courseData.grade === 'A' ? 'selected' : ''}>A</option>
                        <option value="B" ${courseData.grade === 'B' ? 'selected' : ''}>B</option>
                        <option value="C" ${courseData.grade === 'C' ? 'selected' : ''}>C</option>
                        <option value="D" ${courseData.grade === 'D' ? 'selected' : ''}>D</option>
                        <option value="E" ${courseData.grade === 'E' ? 'selected' : ''}>E</option>
                        <option value="F" ${courseData.grade === 'F' ? 'selected' : ''}>F</option>
                    </select>
                </div>
                <div>
                    <label for="creditUnit${courseCounter}">Credit Units:</label>
                    <input type="number" id="creditUnit${courseCounter}" min="1" max="10" value="${courseData.credit_unit || 3}" required>
                </div>
                <button type="button" class="remove-course-btn" data-id="${courseCounter}">X</button>
            `;
            courseInputsDiv.appendChild(courseDiv);
            hideMessage();
        }
        
        // Function to get all course data from inputs
        function getCourseData() {
            const courses = [];
            const courseRows = document.querySelectorAll('.course-input');
            let isValid = true;
        
            courseRows.forEach(row => {
                const gradeSelect = row.querySelector('select[id^="grade"]');
                const creditUnitInput = row.querySelector('input[id^="creditUnit"]');
                const courseNameInput = row.querySelector('input[id^="courseName"]');
        
                const grade = gradeSelect.value;
                const creditUnit = parseFloat(creditUnitInput.value);
                const courseName = courseNameInput.value.trim();
        
                if (!courseName || !grade || isNaN(creditUnit) || creditUnit <= 0) {
                    isValid = false;
                    return;
                }
        
                courses.push({
                    course_name: courseName,
                    grade: grade,
                    credit_unit: creditUnit
                });
            });
        
            return isValid ? courses : null;
        }

        // Function to save the current session data to localStorage
        function saveSession() {
            const courses = getCourseData();
            const tcgpa = tcgpaInput.value.trim();
            if (courses && courses.length > 0) {
                localStorage.setItem('cgpa_courses', JSON.stringify(courses));
                localStorage.setItem('cgpa_tcgpa', tcgpa);
            } else {
                localStorage.removeItem('cgpa_courses');
                localStorage.removeItem('cgpa_tcgpa');
            }
        }

        // Function to load saved session data from localStorage
        function loadSession() {
            const savedCourses = localStorage.getItem('cgpa_courses');
            const savedTcgpa = localStorage.getItem('cgpa_tcgpa');
            
            if (savedCourses) {
                const courses = JSON.parse(savedCourses);
                if (courses.length > 0) {
                    // Clear existing rows and add saved ones
                    courseInputsDiv.innerHTML = '';
                    courses.forEach(course => addCourseInput(course));
                }
            } else {
                // If no saved data, add one empty row
                addCourseInput();
            }

            if (savedTcgpa) {
                tcgpaInput.value = savedTcgpa;
            }
        }
        
        // Event listener for the "Add Course" button
        document.querySelector('.add-course-btn').addEventListener('click', addCourseInput);

        // Event listener for the "Calculate CGPA" button
        document.querySelector('.calculate-btn').addEventListener('click', () => {
            const courses = getCourseData();
            if (!courses) {
                showMessage('Please fill in all course details before calculating.');
                return;
            }

            calculateCGPA(courses);
            saveSession(); // Save session after a successful calculation
        });

        // Event delegation for the remove button
        courseInputsDiv.addEventListener('click', (event) => {
            if (event.target.classList.contains('remove-course-btn')) {
                event.target.closest('.course-input').remove();
                saveSession(); // Save session after removing a course
            }
        });

        // Function to send data to backend and calculate CGPA
        async function calculateCGPA(courses) {
            hideMessage();
            try {
                const response = await fetch('/api/calculate_cgpa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ courses: courses })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    totalGradePointsSpan.textContent = data.total_grade_points.toFixed(2);
                    cgpaValueSpan.textContent = data.cgpa.toFixed(2);
                    classOfDegreeH3.textContent = `Class of Degree: ${data.class_of_degree}`;
                    resultsDiv.style.display = 'block';
                } else {
                    showMessage(data.error || 'Error calculating CGPA.', 'error');
                    resultsDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showMessage('An unexpected error occurred. Please try again.', 'error');
                resultsDiv.style.display = 'none';
            }
        }

        // Load saved data when the page loads
        document.addEventListener('DOMContentLoaded', loadSession);
    </script>
</body>
</html>
